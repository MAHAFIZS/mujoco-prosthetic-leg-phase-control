<mujoco model="dummy_human_prosthetic">
  <compiler angle="radian" coordinate="local"/>
  <option timestep="0.002" gravity="0 0 -9.81" integrator="RK4"/>
  <size njmax="6000" nconmax="1200"/>

  <default>
    <joint damping="3" armature="0.03" limited="true"/>
    <geom friction="2.8 1.0 0.02" density="800" contype="1" conaffinity="1"/>
  </default>

  <asset>
    <texture type="skybox" builtin="gradient"
             rgb1="0.4 0.6 0.9" rgb2="0.0 0.0 0.0" width="512" height="512"/>
    <material name="mat_floor" rgba="0.92 0.92 0.92 1"/>
    <material name="mat_body"  rgba="0.85 0.75 0.65 1"/>
    <material name="mat_pros"  rgba="0.2 0.2 0.25 1"/>
    <material name="mat_pin"   rgba="1 0 0 0.6"/>
  </asset>

  <worldbody>
    <!-- Floor -->
    <geom name="floor" type="plane" size="6 6 0.1" material="mat_floor"
          contype="1" conaffinity="1" friction="3.2 1.2 0.02"/>

    <!-- Mocap "pin target" we can move at runtime -->
    <body name="pin_mocap" mocap="true" pos="0 0 0">
      <site name="pin_site" pos="0 0 0" size="0.012" material="mat_pin"/>
    </body>

    <!-- Pelvis with "harness": allow XY translation + Z height controlled + yaw only -->
    <!-- NOTE: pelvis pos is 0, height comes from pelvis_tz joint (set in Python + actuator) -->
    <body name="pelvis" pos="0 0 0">
      <!-- Horizontal drift allowed, but damped -->
      <joint name="pelvis_tx" type="slide" axis="1 0 0" range="-1.0 1.0" damping="5"/>
      <joint name="pelvis_ty" type="slide" axis="0 1 0" range="-1.0 1.0" damping="5"/>

      <!-- Vertical height (harness controlled) -->
      <joint name="pelvis_tz" type="slide" axis="0 0 1" range="0.6 1.2" damping="20"/>

      <!-- Keep torso upright: yaw only (no pitch/roll) -->
      <joint name="pelvis_yaw" type="hinge" axis="0 0 1" range="-3.14 3.14" damping="2"/>

      <geom name="pelvis_geom" type="capsule" fromto="0 0 0  0 0 0.25" size="0.09" material="mat_body"/>

      <!-- Left leg: passive (visual only) -->
      <body name="left_hip" pos="0 0.09 0.02">
        <joint name="l_hip" type="hinge" axis="0 1 0" range="-1.2 1.2"/>
        <geom type="capsule" fromto="0 0 0  0 0 -0.35" size="0.05" material="mat_body"/>
        <body name="left_knee" pos="0 0 -0.35">
          <joint name="l_knee" type="hinge" axis="0 1 0" range="-2.2 0.2"/>
          <geom type="capsule" fromto="0 0 0  0 0 -0.35" size="0.045" material="mat_body"/>
          <body name="left_ankle" pos="0 0 -0.35">
            <joint name="l_ankle" type="hinge" axis="0 1 0" range="-0.7 0.7"/>
            <geom type="capsule" fromto="0 0 0  0 0 -0.10" size="0.04" material="mat_body"/>
            <geom name="l_foot" type="box" pos="0.10 0 -0.12" size="0.14 0.05 0.02" material="mat_body"/>
          </body>
        </body>
      </body>

      <!-- Right prosthetic leg: actuated -->
      <body name="right_hip" pos="0 -0.09 0.02">
        <joint name="r_hip" type="hinge" axis="0 1 0" range="-0.8 0.8"/>
        <geom name="r_thigh" type="capsule" fromto="0 0 0  0 0 -0.33" size="0.05" material="mat_pros"/>

        <body name="right_knee" pos="0 0 -0.33">
          <joint name="r_knee" type="hinge" axis="0 1 0" range="-0.9 0.1"/>
          <geom name="r_shank" type="capsule" fromto="0 0 0  0 0 -0.33" size="0.045" material="mat_pros"/>

          <body name="right_ankle" pos="0 0 -0.33">
            <joint name="r_ankle" type="hinge" axis="0 1 0" range="-0.9 0.9"/>
            <geom name="r_ankle_link" type="capsule" fromto="0 0 0  0 0 -0.10" size="0.04" material="mat_pros"/>

            <geom name="r_foot" type="box" pos="0.18 0 -0.12" size="0.18 0.05 0.02"
                  material="mat_pros" friction="3.2 1.2 0.02"/>
            <geom name="r_heel" type="box" pos="-0.06 0 -0.12" size="0.06 0.05 0.02"
                  material="mat_pros" friction="3.2 1.2 0.02"/>

            <!-- Stance pin site -->
            <site name="r_pin" pos="0.03 0 -0.12" size="0.012" material="mat_pin"/>
            <site name="r_toe" pos="0.18 0 -0.12" size="0.01"/>
          </body>
        </body>
      </body>

      <!-- Upper body marker -->
      <body name="upper" pos="0 0 0.25">
        <geom type="capsule" fromto="0 0 0  0 0 0.30" size="0.07" material="mat_body"/>
        <geom type="sphere" pos="0 0 0.38" size="0.10" material="mat_body"/>
      </body>
    </body>

    <light pos="0 0 3" dir="0 0 -1"/>
    <camera name="cam" mode="trackcom" pos="2.8 0 1.2" xyaxes="0 1 0  0 0 1"/>
  </worldbody>

  <actuator>
    <!-- Harness: hold pelvis height -->
    <position name="pelvis_height" joint="pelvis_tz" kp="2500" ctrlrange="0.75 1.10"/>

    <!-- Prosthetic leg joint position actuators -->
    <position name="m_r_hip"   joint="r_hip"   kp="120" ctrlrange="-0.8 0.8"/>
    <position name="m_r_knee"  joint="r_knee"  kp="180" ctrlrange="-0.9 0.1"/>
    <position name="m_r_ankle" joint="r_ankle" kp="120" ctrlrange="-0.9 0.9"/>
  </actuator>

  <!-- Stance pin constraint -->
  <equality>
    <connect name="stance_pin" site1="r_pin" site2="pin_site"
             solref="0.01 1" solimp="0.95 0.99 0.001"/>
  </equality>
</mujoco>
